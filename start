#!/usr/bin/env bash
# Start InfiniClaw. Syncs code, builds, installs launchd services.
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/scripts/common.sh"

required_cmd rsync
required_cmd node

NODE_BIN="$(command -v node)"
LAUNCH_AGENTS_DIR="${HOME}/Library/LaunchAgents"
mkdir -p "${LAUNCH_AGENTS_DIR}" "${LOG_DIR}"

ensure_podman_ready

start_bot() {
  local bot="$1"
  local label="com.infiniclaw.${bot}"
  local plist_path="${LAUNCH_AGENTS_DIR}/${label}.plist"
  local instance
  instance="$(instance_dir "$bot")"
  mkdir -p "${instance}"

  # Sync vendored code to instance
  rsync -a --delete \
    --exclude node_modules \
    --exclude data \
    --exclude store \
    --exclude groups \
    --exclude logs \
    "${BASE_NANOCLAW_DIR}/" "${instance}/"

  # Install deps if needed
  if [[ ! -d "${instance}/node_modules" ]] || \
     ! diff -q "${BASE_NANOCLAW_DIR}/package-lock.json" "${instance}/node_modules/.package-lock.json" >/dev/null 2>&1; then
    echo "${bot}: installing dependencies..."
    (cd "${instance}" && npm ci)
    cp "${instance}/package-lock.json" "${instance}/node_modules/.package-lock.json" 2>/dev/null || true
  fi

  # Build TypeScript
  echo "${bot}: building..."
  (cd "${instance}" && npm run build)

  # Load profile env
  load_profile_env "$bot"
  apply_brain_env

  # Unload existing plist if present
  launchctl unload "${plist_path}" 2>/dev/null || true

  # Generate plist with expanded env vars
  cat > "${plist_path}" <<PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${label}</string>
    <key>ProgramArguments</key>
    <array>
        <string>${NODE_BIN}</string>
        <string>${instance}/dist/index.js</string>
    </array>
    <key>WorkingDirectory</key>
    <string>${instance}</string>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>${HOME}/.local/bin:/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin</string>
        <key>HOME</key>
        <string>${HOME}</string>
        <key>INFINICLAW_ROOT</key>
        <string>${ROOT_DIR}</string>
        <key>ASSISTANT_NAME</key>
        <string>${ASSISTANT_NAME:-}</string>
        <key>ASSISTANT_TRIGGER</key>
        <string>${ASSISTANT_TRIGGER:-}</string>
        <key>ASSISTANT_ROLE</key>
        <string>${ASSISTANT_ROLE:-}</string>
        <key>IGNORE_TRIGGERS</key>
        <string>${IGNORE_TRIGGERS:-}</string>
        <key>IGNORE_SENDERS</key>
        <string>${IGNORE_SENDERS:-}</string>
        <key>MATRIX_HOMESERVER</key>
        <string>${MATRIX_HOMESERVER:-}</string>
        <key>MATRIX_ACCESS_TOKEN</key>
        <string>${MATRIX_ACCESS_TOKEN:-}</string>
        <key>MATRIX_USER_ID</key>
        <string>${MATRIX_USER_ID:-}</string>
        <key>MATRIX_USERNAME</key>
        <string>${MATRIX_USERNAME:-}</string>
        <key>MATRIX_PASSWORD</key>
        <string>${MATRIX_PASSWORD:-}</string>
        <key>MATRIX_DEVICE_NAME</key>
        <string>${MATRIX_DEVICE_NAME:-}</string>
        <key>LOCAL_MIRROR_MATRIX_JID</key>
        <string>${LOCAL_MIRROR_MATRIX_JID:-}</string>
        <key>LOCAL_CHAT_SENDER_NAME</key>
        <string>${LOCAL_CHAT_SENDER_NAME:-}</string>
        <key>CONTAINER_IMAGE</key>
        <string>${CONTAINER_IMAGE:-nanoclaw-agent:latest}</string>
        <key>LOG_LEVEL</key>
        <string>${LOG_LEVEL:-info}</string>
        <key>ANTHROPIC_MODEL</key>
        <string>${ANTHROPIC_MODEL:-}</string>
        <key>ANTHROPIC_BASE_URL</key>
        <string>${ANTHROPIC_BASE_URL:-}</string>
        <key>ANTHROPIC_API_KEY</key>
        <string>${ANTHROPIC_API_KEY:-}</string>
        <key>ANTHROPIC_AUTH_TOKEN</key>
        <string>${ANTHROPIC_AUTH_TOKEN:-}</string>
        <key>CLAUDE_CODE_OAUTH_TOKEN</key>
        <string>${CLAUDE_CODE_OAUTH_TOKEN:-}</string>
    </dict>
    <key>StandardOutPath</key>
    <string>${LOG_DIR}/${bot}.log</string>
    <key>StandardErrorPath</key>
    <string>${LOG_DIR}/${bot}.error.log</string>
</dict>
</plist>
PLIST

  launchctl load "${plist_path}"
  echo "${bot}: started (${label})"
}

# Install mount allowlist if not already present
ALLOWLIST_DIR="${HOME}/.config/nanoclaw"
ALLOWLIST_FILE="${ALLOWLIST_DIR}/mount-allowlist.json"
if [[ ! -f "${ALLOWLIST_FILE}" ]]; then
  mkdir -p "${ALLOWLIST_DIR}"
  cp "${ROOT_DIR}/config/mount-allowlist.json" "${ALLOWLIST_FILE}"
  echo "Installed mount allowlist: ${ALLOWLIST_FILE}"
fi

for bot in engineer commander; do
  start_bot "$bot" || true
done

echo ""
echo "InfiniClaw running. Check status:"
echo "  launchctl list | grep infiniclaw"
