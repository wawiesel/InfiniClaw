#!/usr/bin/env bash
# Direct terminal chat with a bot. Messages mirror to Matrix.
# Usage: ./scripts/chat <bot-name>
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/common.sh"

BOT="${1:?Usage: $0 <bot-name>}"
INSTANCE="$(instance_dir "$BOT")"

required_cmd npm
required_cmd podman

if [[ ! -d "$INSTANCE" ]]; then
  echo "Missing instance for ${BOT}. Run scripts/start first." >&2
  exit 1
fi

# Sync code from vendored nanoclaw
rsync -a --delete \
  --exclude node_modules \
  --exclude data \
  --exclude store \
  --exclude groups \
  --exclude logs \
  "${BASE_NANOCLAW_DIR}/" "${INSTANCE}/"

# Build TypeScript if needed
if [[ ! -f "${INSTANCE}/dist/index.js" ]] || \
   [[ -n "$(find "${INSTANCE}/src" -name '*.ts' -newer "${INSTANCE}/dist/index.js" 2>/dev/null | head -1)" ]]; then
  echo "Building TypeScript..."
  (cd "${INSTANCE}" && npm run build)
fi

load_profile_env "$BOT"
apply_brain_env
export INFINICLAW_ROOT="${ROOT_DIR}"
export PERSONA_NAME="${BOT}"
export LOCAL_CHANNEL_ENABLED=1
export LOCAL_CHAT_JID="${LOCAL_MIRROR_MATRIX_JID}"
export LOCAL_CHAT_NAME="${BOT} (Terminal)"

ensure_podman_ready

cd "$INSTANCE"
exec npm start
