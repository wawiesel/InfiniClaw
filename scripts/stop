#!/usr/bin/env bash
# Stop InfiniClaw. Unloads launchd services and cleans up containers.
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/common.sh"

LAUNCH_AGENTS_DIR="${HOME}/Library/LaunchAgents"

# Save persona group memory before stopping
for bot in engineer commander; do
  sync_persona "$bot" 2>/dev/null || true
done

for bot in engineer commander; do
  label="com.infiniclaw.${bot}"
  plist_path="${LAUNCH_AGENTS_DIR}/${label}.plist"
  if [[ -f "${plist_path}" ]]; then
    launchctl unload "${plist_path}" 2>/dev/null || true
    rm -f "${plist_path}"
    echo "${bot}: stopped and uninstalled"
  else
    echo "${bot}: not installed"
  fi
done

# Remove legacy single-bot plist if it exists
if [[ -f "${LAUNCH_AGENTS_DIR}/com.nanoclaw.plist" ]]; then
  launchctl unload "${LAUNCH_AGENTS_DIR}/com.nanoclaw.plist" 2>/dev/null || true
  rm -f "${LAUNCH_AGENTS_DIR}/com.nanoclaw.plist"
  echo "Removed legacy com.nanoclaw.plist"
fi

# Kill any rogue nanoclaw node processes not managed by launchctl
pgrep -f 'nanoclaw.*dist/index\.js' 2>/dev/null | while read -r pid; do
  kill "$pid" 2>/dev/null || true
done || true

# Stop all nanoclaw podman containers
if command -v podman >/dev/null 2>&1; then
  podman ps --format '{{.Names}}' 2>/dev/null | grep '^nanoclaw-' | while read -r name; do
    echo "Stopping container $name"
    podman stop -t 5 "$name" 2>/dev/null || true
  done
fi

echo "InfiniClaw stopped."
