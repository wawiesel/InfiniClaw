#!/usr/bin/env bash
# Stop InfiniClaw. Kills all bots, supervisors, orphans, and containers.
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/scripts/common.sh"

echo "=== Stopping InfiniClaw ==="

for bot in engineer commander; do
  # Signal supervisor to not restart
  touch "${RUN_DIR}/${bot}.stop"

  # Kill bot process
  if [[ -f "${RUN_DIR}/${bot}.pid" ]]; then
    pid="$(cat "${RUN_DIR}/${bot}.pid")"
    if kill -0 "$pid" 2>/dev/null; then
      echo "Killing ${bot} (pid $pid)"
      kill "$pid" 2>/dev/null || true
      sleep 1
      kill -0 "$pid" 2>/dev/null && kill -9 "$pid" 2>/dev/null || true
    fi
    rm -f "${RUN_DIR}/${bot}.pid"
  fi

  # Kill supervisor
  if [[ -f "${RUN_DIR}/${bot}.supervisor.pid" ]]; then
    pid="$(cat "${RUN_DIR}/${bot}.supervisor.pid")"
    kill "$pid" 2>/dev/null || true
    rm -f "${RUN_DIR}/${bot}.supervisor.pid"
  fi

  rm -f "${RUN_DIR}/${bot}.stop"
done

# Kill any orphaned processes
pgrep -f "${ROOT_DIR}/instances/.*/nanoclaw" 2>/dev/null | while read -r pid; do
  echo "Killing orphan $pid"
  kill "$pid" 2>/dev/null || true
done
sleep 1
pgrep -f "${ROOT_DIR}/instances/.*/nanoclaw" 2>/dev/null | while read -r pid; do
  kill -9 "$pid" 2>/dev/null || true
done

# Stop all nanoclaw podman containers
if command -v podman >/dev/null 2>&1; then
  podman ps --format '{{.Names}}' 2>/dev/null | grep '^nanoclaw-' | while read -r name; do
    echo "Stopping container $name"
    podman stop "$name" 2>/dev/null || true
  done
fi

# Clean up all PID files
rm -f "${RUN_DIR}"/*.pid "${RUN_DIR}"/*.stop

echo "=== InfiniClaw stopped ==="
