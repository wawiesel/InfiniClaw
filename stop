#!/usr/bin/env bash
# Stop InfiniClaw. Unloads launchd services and cleans up containers.
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/scripts/common.sh"

LAUNCH_AGENTS_DIR="${HOME}/Library/LaunchAgents"

for bot in engineer commander; do
  label="com.infiniclaw.${bot}"
  plist_path="${LAUNCH_AGENTS_DIR}/${label}.plist"
  if [[ -f "${plist_path}" ]]; then
    launchctl unload "${plist_path}" 2>/dev/null || true
    rm -f "${plist_path}"
    echo "${bot}: stopped and uninstalled"
  else
    echo "${bot}: not installed"
  fi
done

# Stop all nanoclaw podman containers
if command -v podman >/dev/null 2>&1; then
  podman ps --format '{{.Names}}' 2>/dev/null | grep '^nanoclaw-' | while read -r name; do
    echo "Stopping container $name"
    podman stop -t 5 "$name" 2>/dev/null || true
  done
fi

echo "InfiniClaw stopped."
